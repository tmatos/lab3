
#include <stdio.h>
#include <stdlib.h>

#define Int16 short
#define Int32 int
#define Uint16 int
 
//#define N_LOW 170;
//#define N_MID 170;
//#define N_HI 171;

#define N 171

Int16 h_low[N] = {
      178,    -18,    -21,    -25,    -31,    -38,    -45,    -51,    -57,
      -61,    -62,    -61,    -58,    -51,    -41,    -29,    -14,      3,
       20,     38,     54,     69,     80,     88,     91,     90,     82,
       70,     52,     30,      5,    -23,    -52,    -80,   -105,   -127,
     -143,   -153,   -154,   -147,   -131,   -106,    -73,    -34,     10,
       58,    106,    151,    192,    225,    249,    260,    257,    239,
      207,    160,     99,     27,    -53,   -138,   -223,   -305,   -377,
     -436,   -476,   -494,   -486,   -448,   -380,   -279,   -148,     13,
      201,    411,    638,    876,   1120,   1360,   1591,   1804,   1994,
     2154,   2279,   2365,   2408,   2408,   2365,   2279,   2154,   1994,
     1804,   1591,   1360,   1120,    876,    638,    411,    201,     13,
     -148,   -279,   -380,   -448,   -486,   -494,   -476,   -436,   -377,
     -305,   -223,   -138,    -53,     27,     99,    160,    207,    239,
      257,    260,    249,    225,    192,    151,    106,     58,     10,
      -34,    -73,   -106,   -131,   -147,   -154,   -153,   -143,   -127,
     -105,    -80,    -52,    -23,      5,     30,     52,     70,     82,
       90,     91,     88,     80,     69,     54,     38,     20,      3,
      -14,    -29,    -41,    -51,    -58,    -61,    -62,    -61,    -57,
      -51,    -45,    -38,    -31,    -25,    -21,    -18,    178,      0
};

Int16 h_mid[N] = {
     -103,     54,   -125,   -124,    -15,     72,     67,      1,    -38,
       -1,     72,     97,     51,      1,     23,    100,    139,     89,
       14,     15,     95,    148,     93,    -16,    -48,     30,    103,
       51,    -87,   -156,    -81,     24,     -5,   -161,   -264,   -187,
      -35,    -15,   -170,   -303,   -226,    -14,     75,    -64,   -231,
     -167,    100,    270,    153,    -67,    -49,    252,    501,    402,
       98,     18,    316,    639,    556,    136,   -101,    155,    560,
      515,    -43,   -496,   -313,    218,    280,   -415,  -1161,  -1080,
     -311,     21,   -803,  -2017,  -2130,   -848,    210,   -751,  -3233,
    -4251,  -1186,   5068,  10206,  10206,   5068,  -1186,  -4251,  -3233,
     -751,    210,   -848,  -2130,  -2017,   -803,     21,   -311,  -1080,
    -1161,   -415,    280,    218,   -313,   -496,    -43,    515,    560,
      155,   -101,    136,    556,    639,    316,     18,     98,    402,
      501,    252,    -49,    -67,    153,    270,    100,   -167,   -231,
      -64,     75,    -14,   -226,   -303,   -170,    -15,    -35,   -187,
     -264,   -161,     -5,     24,    -81,   -156,    -87,     51,    103,
       30,    -48,    -16,     93,    148,     95,     15,     14,     89,
      139,    100,     23,      1,     51,     97,     72,     -1,    -38,
        1,     67,     72,    -15,   -124,   -125,     54,   -103,      0
};

Int16 h_hi[N] = {
       35,   -192,    -40,     19,     40,     13,    -32,    -43,     -2,
       45,     42,    -13,    -57,    -35,     31,     65,     23,    -51,
      -69,     -4,     71,     65,    -20,    -88,    -54,     48,    100,
       34,    -79,   -104,     -5,    108,     98,    -32,   -133,    -81,
       74,    150,     50,   -119,   -156,     -6,    163,    147,    -49,
     -200,   -120,    113,    227,     73,   -182,   -236,     -7,    251,
      224,    -79,   -312,   -185,    181,    359,    114,   -296,   -384,
       -7,    420,    376,   -139,   -545,   -324,    333,    666,    211,
     -586,   -777,     -8,    931,    870,   -356,  -1463,   -941,   1117,
     2576,    986,  -3934,  -9490,  20845,  -9490,  -3934,    986,   2576,
     1117,   -941,  -1463,   -356,    870,    931,     -8,   -777,   -586,
      211,    666,    333,   -324,   -545,   -139,    376,    420,     -7,
     -384,   -296,    114,    359,    181,   -185,   -312,    -79,    224,
      251,     -7,   -236,   -182,     73,    227,    113,   -120,   -200,
      -49,    147,    163,     -6,   -156,   -119,     50,    150,     74,
      -81,   -133,    -32,     98,    108,     -5,   -104,    -79,     34,
      100,     48,    -54,    -88,    -20,     65,     71,     -4,    -69,
      -51,     23,     65,     31,    -35,    -57,    -13,     42,     45,
       -2,    -43,    -32,     13,     40,     19,    -40,   -192,     35
};

#define LOW 0
#define MID 1
#define HI 2

double ganho[3] = { 1.0, 1.0, 1.0 };

Int16 impulso = 1;

// simular a leitura de impulso
void EZDSP5502_MCBSP_read(Int16 *var)
{
    *var = impulso;

    if(impulso)
    {
      impulso--;
    }
}

FILE *fp;

void EZDSP5502_MCBSP_read_signal(Int16 *var)
{
    fscanf(fp, "%hd", var);
}

void InicializaAudio()
{
    fp = fopen("3sine.dat", "r");

    if( !fp )
    {
        printf("File??????\n");
        exit(1);
    }
}

int main()
{
    Int16 dataLeft, dataRight;
    
    Int16 buff[N]; // buffer circular para guardar as amostras
    
    Int16 i; // indice do buffer indicando a posicao da ultima leitura
    
    Int16 j; // indice para iteracao no buffer circular
    Int16 k; // indice para iteracao nos coeficientes

    Int16 posOldest; // posicao no buffer da amostra mais antiga

    int s;
    
    Int32 acc[3]; // acumuladores usados para convolucao
  
    InicializaAudio();
    
    // set bufffer para valor inicial
    for( i = 0 ; i < N ; ++i )
    {
      buff[i] = 0;
    }
    
    dataLeft = 0;
    dataRight = 0;
    
    i = 0;
    k = 0;
    
    //for ( s = 0 ; s < 10 ; s++ )
    while(!feof(fp))
    {
      for ( i=0 ; i<N ; ++i, !feof(fp) )
      {
        EZDSP5502_MCBSP_read_signal(&dataLeft);      // RX left channel
        //EZDSP5502_MCBSP_read_signal(&dataRight);     // RX right  channel
        
        buff[i] = dataLeft;

        posOldest = (i+1) % N;

        //== LOW ==============================================================

        for( k=0, acc[LOW]=0, j=posOldest ; j<N ; ++j, ++k )
        {
          acc[LOW] += (Int32)h_low[k] * (Int32)buff[j]; 
        }

        for( j=0 ; j<posOldest ; ++j, ++k )
        {
          acc[LOW] += (Int32)h_low[k] * (Int32)buff[j]; 
        }

        acc[LOW] += 0x00004000;

        
        //== MID ==============================================================

        for( k=0, acc[MID]=0, j=posOldest ; j<N ; ++j, ++k )
        {
          acc[MID] += (Int32)h_mid[k] * (Int32)buff[j]; 
        }

        for( j=0 ; j<posOldest ; ++j, ++k )
        {
          acc[MID] += (Int32)h_mid[k] * (Int32)buff[j]; 
        }

        acc[MID] += 0x00004000;


        //== HI ===============================================================

        for( k=0, acc[HI]=0, j=posOldest ; j<N ; ++j, ++k )
        {
          acc[HI] += (Int32)h_hi[k] * (Int32)buff[j]; 
        }

        for( j=0 ; j<posOldest ; ++j, ++k )
        {
          acc[HI] += (Int32)h_hi[k] * (Int32)buff[j]; 
        }

        acc[HI] += 0x00004000;

        //=====================================================================

        // converte para os 16 bits enquanto aplica os ganhos

        dataLeft = (Int16)( (double)(acc[LOW] >> 15) * ganho[LOW] +
                            (double)(acc[MID] >> 15) * ganho[MID] +
                            (double)(acc[HI] >> 15)  * ganho[HI] );

        printf("%hd ", dataLeft);
      }

    }

    fclose(fp);

    return 0;
}
